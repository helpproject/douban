$(function(){var b,j;var i={x1:0,y1:0,x2:0,y2:0,width:0,height:0};var a=true;function e(n,p){var o=48/p.width;var m=48/p.height;$("#preimg").css({width:Math.round(o*b)+"px",height:Math.round(m*j)+"px",marginLeft:"-"+Math.round(o*p.x1)+"px",marginTop:"-"+Math.round(m*p.y1)+"px"});if($("#imgpos")){$("#imgpos").attr("value",p.x1+"_"+p.y1+"_"+(p.x2-p.x1)).attr("name","imgpos")}}$("li.user-icon h5 a").click(function(m){m.preventDefault();if(!a){return}if($("li.user-icon form")[0].style.display=="block"){$("div.imgareaselect-outer").hide();$("div.imgareaselect-outer").prev().hide()}else{setTimeout(function(){$("div.imgareaselect-outer").show();$("div.imgareaselect-outer").prev().show()},500)}$(this).parent().next("form").slideToggle("normal")});$("li.user-intro h5 a").click(function(m){m.preventDefault();$(this).parent().next("form").slideToggle("normal")});var g="/accounts/user_icon/upload",l="usr-icon-upload",h="正在上传中，请稍候...",f=$.extend(Douban.errdetail,{2:"照片太大(每张照片的大小不应超过3M)",10:"你没有选择图像文件",12:"请选择JPG、JPEG、GIF、PNG或BMP文件",14:"添加图片出错"}),c=function(){var n=$("#"+l).attr("disabled",1).parent(),m=n.find(".error"),o=n.find(".waiting");m.hide();if(o.length===0){o=$('<span class="waiting">'+h+"</span>").appendTo(n);return}o.show()},d=function(m){var o=$("#"+l).attr("disabled",0).parent(),n=o.find(".error");if(n.length===0){n=$('<span class="error">'+m+"</span>").appendTo(o);return}n.show().html(m)},k=function(){if($("#usr-icon-upload").val()==""){return}a=false;$.ajaxFileUpload({url:g,global:true,secureuri:false,fileElementId:l,dataType:"json",timeout:120000,allowType:"jpg|png|bmp|gif|jpeg",extra:{needtype:"json",ck:get_cookie("ck")},success:function(n,m){if(!n.r){$("#"+l).parent().find(".waiting").hide();d(f[14+""]);return}var o=$("#"+this.fileElementId).attr("disabled",0).parent();o.find(".error,.waiting").hide();$("img#bigimg").attr("src",n.pic);$("img#preimg").attr("src",n.pic);$("img#bigimg")[0].onload=function(){$("#imgpos").attr("value",0+"_"+0+"_"+0);b=$("#bigimg").width();j=$("#bigimg").height();var p=$("#imgpos").attr("value").split("_");var q=(p[2]!="0")?{x1:parseInt(p[0]),y1:parseInt(p[1]),x2:parseInt(p[0])+parseInt(p[2]),y2:parseInt(p[1])+parseInt(p[2])}:{x1:b>j?(b-j)/2+3:3,x2:b>j?(b+j)/2-3:b-3,y1:b>j?3:(j-b)/2+3,y2:b>j?j-3:(j+b)/2-3};$("#bigimg").imgAreaSelect($.extend(q,{aspectRatio:"1:1",onSelectChange:e,onSelectBegin:e,minWidth:20,noNewSelect:"true"}))};a=true},begin:function(m){if(m){d(f[m+""]);return}c()},error:function(n,m,o){d(f[o+""])}});$("#"+l).bind("change",k)};$("#"+l).bind("change",k);$("#choose_submit").click(function(){$.post_withck(g,{imgpos:$("#imgpos").val()},function(m){if(m.r){window.location.reload()}},"json")});$("#intro_submit").click(function(){$.post_withck("/j/accounts/intro",{text:$("#text").val()},function(m){if(m.r){$("p.error").text("");window.location.reload()}else{$("p.error").text("自我介绍有禁用的内容，请重新修改")}},"json")})});